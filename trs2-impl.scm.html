<!DOCTYPE html>
<html>
<head>
<meta http-equiv=Content-Type content="text/html;charset=utf-8">
<title>~/CodeFromTheReasonedSchemer2ndEd/trs2-impl.scm</title>
<style type="text/css">
* { border: 0; margin: 0; outline: 0; padding: 0; vertical-align: baseline; }
code, kbd, pre, samp { font-family: monospace, monospace; font-size: 1rem; }
html { -moz-osx-font-smoothing: grayscale; -webkit-font-smoothing: antialiased; }
table { border-collapse: collapse; border-spacing: 0; }
body { padding: 1rem; }
h1, h2, h3, h4 { line-height: 1.25; margin-bottom: 0.5rem; }
h1 { font-size: 1.296rem; }
h2 { font-size: 1.215rem; }
h3 { font-size: 1.138rem; }
h4 { font-size: 1.067rem; }
html { font-family: monospace, monospace; font-size: 1rem; }
p { margin-bottom: 1.25rem; }
.pc0 { background-color: #111111; color: white; white-space: nowrap; }
.pc1 { background-color: #607D8B; color: white; white-space: nowrap; }
.pc2 { background-color: #9C27B0; color: black; white-space: nowrap; }
.pc3 { background-color: #673AB7; color: white; white-space: nowrap; }
.pc4 { background-color: #3F51B5; color: white; white-space: nowrap; }
.pc5 { background-color: #2196F3; color: black; white-space: nowrap; }
.pc6 { background-color: #00BCD4; color: black; white-space: nowrap; }
.pc7 { background-color: #4CAF50; color: black; white-space: nowrap; }
.pc8 { background-color: #CDDC39; color: black; white-space: nowrap; }
.pc9 { background-color: #FFEB3B; color: black; white-space: nowrap; }
.pc10 { background-color: #FFC107; color: black; white-space: nowrap; }
.pc11 { background-color: #FF9800; color: black; white-space: nowrap; }
.pc12 { background-color: #F44336; color: white; white-space: nowrap; }
</style>
</head>
<body class=pc0>
<h1 style="margin-bottom: 1rem">~/CodeFromTheReasonedSchemer2ndEd/trs2-impl.scm<span style="opacity: 0.5"> on Sun May 29 01:21:00 2022</span></h1>
<table><tr><td style="color: #666666; font-weight: bold; padding-right: 1rem; text-align: right"><pre>
<span id=line1>1
</span><span id=line2>2
</span><span id=line3>3
</span><span id=line4>4
</span><span id=line5>5
</span><span id=line6>6
</span><span id=line7>7
</span><span id=line8>8
</span><span id=line9>9
</span><span id=line10>10
</span><span id=line11>11
</span><span id=line12>12
</span><span id=line13>13
</span><span id=line14>14
</span><span id=line15>15
</span><span id=line16>16
</span><span id=line17>17
</span><span id=line18>18
</span><span id=line19>19
</span><span id=line20>20
</span><span id=line21>21
</span><span id=line22>22
</span><span id=line23>23
</span><span id=line24>24
</span><span id=line25>25
</span><span id=line26>26
</span><span id=line27>27
</span><span id=line28>28
</span><span id=line29>29
</span><span id=line30>30
</span><span id=line31>31
</span><span id=line32>32
</span><span id=line33>33
</span><span id=line34>34
</span><span id=line35>35
</span><span id=line36>36
</span><span id=line37>37
</span><span id=line38>38
</span><span id=line39>39
</span><span id=line40>40
</span><span id=line41>41
</span><span id=line42>42
</span><span id=line43>43
</span><span id=line44>44
</span><span id=line45>45
</span><span id=line46>46
</span><span id=line47>47
</span><span id=line48>48
</span><span id=line49>49
</span><span id=line50>50
</span><span id=line51>51
</span><span id=line52>52
</span><span id=line53>53
</span><span id=line54>54
</span><span id=line55>55
</span><span id=line56>56
</span><span id=line57>57
</span><span id=line58>58
</span><span id=line59>59
</span><span id=line60>60
</span><span id=line61>61
</span><span id=line62>62
</span><span id=line63>63
</span><span id=line64>64
</span><span id=line65>65
</span><span id=line66>66
</span><span id=line67>67
</span><span id=line68>68
</span><span id=line69>69
</span><span id=line70>70
</span><span id=line71>71
</span><span id=line72>72
</span><span id=line73>73
</span><span id=line74>74
</span><span id=line75>75
</span><span id=line76>76
</span><span id=line77>77
</span><span id=line78>78
</span><span id=line79>79
</span><span id=line80>80
</span><span id=line81>81
</span><span id=line82>82
</span><span id=line83>83
</span><span id=line84>84
</span><span id=line85>85
</span><span id=line86>86
</span><span id=line87>87
</span><span id=line88>88
</span><span id=line89>89
</span><span id=line90>90
</span><span id=line91>91
</span><span id=line92>92
</span><span id=line93>93
</span><span id=line94>94
</span><span id=line95>95
</span><span id=line96>96
</span><span id=line97>97
</span><span id=line98>98
</span><span id=line99>99
</span><span id=line100>100
</span><span id=line101>101
</span><span id=line102>102
</span><span id=line103>103
</span><span id=line104>104
</span><span id=line105>105
</span><span id=line106>106
</span><span id=line107>107
</span><span id=line108>108
</span><span id=line109>109
</span><span id=line110>110
</span><span id=line111>111
</span><span id=line112>112
</span><span id=line113>113
</span><span id=line114>114
</span><span id=line115>115
</span><span id=line116>116
</span><span id=line117>117
</span><span id=line118>118
</span><span id=line119>119
</span><span id=line120>120
</span><span id=line121>121
</span><span id=line122>122
</span><span id=line123>123
</span><span id=line124>124
</span><span id=line125>125
</span><span id=line126>126
</span><span id=line127>127
</span><span id=line128>128
</span><span id=line129>129
</span><span id=line130>130
</span><span id=line131>131
</span><span id=line132>132
</span><span id=line133>133
</span><span id=line134>134
</span><span id=line135>135
</span><span id=line136>136
</span><span id=line137>137
</span><span id=line138>138
</span><span id=line139>139
</span><span id=line140>140
</span><span id=line141>141
</span><span id=line142>142
</span><span id=line143>143
</span><span id=line144>144
</span><span id=line145>145
</span><span id=line146>146
</span><span id=line147>147
</span><span id=line148>148
</span><span id=line149>149
</span><span id=line150>150
</span><span id=line151>151
</span><span id=line152>152
</span><span id=line153>153
</span><span id=line154>154
</span><span id=line155>155
</span><span id=line156>156
</span><span id=line157>157
</span><span id=line158>158
</span><span id=line159>159
</span><span id=line160>160
</span><span id=line161>161
</span><span id=line162>162
</span><span id=line163>163
</span><span id=line164>164
</span><span id=line165>165
</span><span id=line166>166
</span><span id=line167>167
</span><span id=line168>168
</span><span id=line169>169
</span><span id=line170>170
</span><span id=line171>171
</span><span id=line172>172
</span><span id=line173>173
</span><span id=line174>174
</span><span id=line175>175
</span><span id=line176>176
</span><span id=line177>177
</span><span id=line178>178
</span><span id=line179>179
</span><span id=line180>180
</span><span id=line181>181
</span><span id=line182>182
</span><span id=line183>183
</span><span id=line184>184
</span><span id=line185>185
</span><span id=line186>186
</span><span id=line187>187
</span><span id=line188>188
</span><span id=line189>189
</span><span id=line190>190
</span><span id=line191>191
</span><span id=line192>192
</span><span id=line193>193
</span><span id=line194>194
</span><span id=line195>195
</span><span id=line196>196
</span><span id=line197>197
</span><span id=line198>198
</span><span id=line199>199
</span><span id=line200>200
</span><span id=line201>201
</span><span id=line202>202
</span><span id=line203>203
</span><span id=line204>204
</span><span id=line205>205
</span><span id=line206>206
</span><span id=line207>207
</span><span id=line208>208
</span><span id=line209>209
</span><span id=line210>210
</span><span id=line211>211
</span><span id=line212>212
</span><span id=line213>213
</span><span id=line214>214
</span><span id=line215>215
</span><span id=line216>216
</span><span id=line217>217
</span><span id=line218>218
</span><span id=line219>219
</span><span id=line220>220
</span><span id=line221>221
</span><span id=line222>222
</span><span id=line223>223
</span><span id=line224>224
</span><span id=line225>225
</span><span id=line226>226
</span><span id=line227>227
</span><span id=line228>228
</span><span id=line229>229
</span><span id=line230>230
</span><span id=line231>231
</span><span id=line232>232
</span></pre></td><td><pre>
;;; Copyright © 2018 Daniel P. Friedman, William E. Byrd, Oleg Kiselyov, and Jason Hemann
;;;
;;; Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the “Software”), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
;;;
;;; The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
;;;
;;; THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.


;;; Implementation of the language used in 'The Reasoned Schemer,
;;; Second Edition,' by Friedman, Byrd, Kiselyov, and Hemann (MIT
;;; Press, 2018).

;;; Definitions are presented in the order in which they appear in
;;; Chapter 10 and Appendix A.


;;; Here are the key parts of Chapter 10

(define var (lambda (x) <span class=pc3 title="line 20 char 25 count 11,983,521">(</span><span class=pc3 title="line 20 char 26 count 11,983,521">vector</span><span class=pc3 title="line 20 char 25 count 11,983,521"> </span><span class=pc3 title="line 20 char 33 count 11,983,521">x</span><span class=pc3 title="line 20 char 25 count 11,983,521">)</span>))
(define var? (lambda (x) <span class=pc12 title="line 21 char 26 count 347,161,386">(</span><span class=pc12 title="line 21 char 27 count 347,161,386">vector?</span><span class=pc12 title="line 21 char 26 count 347,161,386"> </span><span class=pc12 title="line 21 char 35 count 347,161,386">x</span><span class=pc12 title="line 21 char 26 count 347,161,386">)</span>))

(define empty-s '())

(define (walk v s)
  <span class=pc11 title="line 26 char 3 count 197,134,064">(let ((a </span><span class=pc11 title="line 26 char 12 count 197,134,064">(and </span><span class=pc11 title="line 26 char 17 count 197,134,064">(</span><span class=pc11 title="line 26 char 18 count 197,134,064">var?</span><span class=pc11 title="line 26 char 17 count 197,134,064"> </span><span class=pc11 title="line 26 char 23 count 197,134,064">v</span><span class=pc11 title="line 26 char 17 count 197,134,064">)</span><span class=pc11 title="line 26 char 12 count 197,134,064"> </span><span class=pc9 title="line 26 char 26 count 55,820,406">(</span><span class=pc9 title="line 26 char 27 count 55,820,406">assv</span><span class=pc9 title="line 26 char 26 count 55,820,406"> </span><span class=pc9 title="line 26 char 32 count 55,820,406">v</span><span class=pc9 title="line 26 char 26 count 55,820,406"> </span><span class=pc9 title="line 26 char 34 count 55,820,406">s</span><span class=pc9 title="line 26 char 26 count 55,820,406">)</span><span class=pc11 title="line 26 char 12 count 197,134,064">)</span><span class=pc11 title="line 26 char 3 count 197,134,064">))</span>
    <span class=pc11 title="line 27 char 5 count 197,134,064">(cond</span>
      <span class=pc11 title="line 27 char 5 count 197,134,064">(</span><span class=pc11 title="line 28 char 8 count 197,134,064">(</span><span class=pc11 title="line 28 char 9 count 197,134,064">pair?</span><span class=pc11 title="line 28 char 8 count 197,134,064"> </span><span class=pc11 title="line 28 char 15 count 197,134,064">a</span><span class=pc11 title="line 28 char 8 count 197,134,064">)</span><span class=pc11 title="line 27 char 5 count 197,134,064"> </span><span class=pc6 title="line 28 char 18 count 34,171,310">(</span><span class=pc6 title="line 28 char 19 count 34,171,310">walk</span><span class=pc6 title="line 28 char 18 count 34,171,310"> </span><span class=pc6 title="line 28 char 24 count 34,171,310">(</span><span class=pc6 title="line 28 char 25 count 34,171,310">cdr</span><span class=pc6 title="line 28 char 24 count 34,171,310"> </span><span class=pc6 title="line 28 char 29 count 34,171,310">a</span><span class=pc6 title="line 28 char 24 count 34,171,310">)</span><span class=pc6 title="line 28 char 18 count 34,171,310"> </span><span class=pc6 title="line 28 char 32 count 34,171,310">s</span><span class=pc6 title="line 28 char 18 count 34,171,310">)</span><span class=pc11 title="line 27 char 5 count 197,134,064">)</span>
      <span class=pc11 title="line 27 char 5 count 197,134,064">(else </span><span class=pc10 title="line 29 char 13 count 162,962,754">v</span><span class=pc11 title="line 27 char 5 count 197,134,064">))</span><span class=pc11 title="line 26 char 3 count 197,134,064">)</span>)

(define (ext-s x v s)
  <span class=pc4 title="line 32 char 3 count 15,927,752">(cond</span>
    <span class=pc4 title="line 32 char 3 count 15,927,752">(</span><span class=pc4 title="line 33 char 6 count 15,927,752">(</span><span class=pc4 title="line 33 char 7 count 15,927,752">occurs?</span><span class=pc4 title="line 33 char 6 count 15,927,752"> </span><span class=pc4 title="line 33 char 15 count 15,927,752">x</span><span class=pc4 title="line 33 char 6 count 15,927,752"> </span><span class=pc4 title="line 33 char 17 count 15,927,752">v</span><span class=pc4 title="line 33 char 6 count 15,927,752"> </span><span class=pc4 title="line 33 char 19 count 15,927,752">s</span><span class=pc4 title="line 33 char 6 count 15,927,752">)</span><span class=pc4 title="line 32 char 3 count 15,927,752"> </span><span class=pc1 title="line 33 char 22 count 0">#f</span><span class=pc4 title="line 32 char 3 count 15,927,752">)</span>
    <span class=pc4 title="line 32 char 3 count 15,927,752">(else </span><span class=pc4 title="line 34 char 11 count 15,927,752">(</span><span class=pc4 title="line 34 char 12 count 15,927,752">cons</span><span class=pc4 title="line 34 char 11 count 15,927,752"> </span><span class=pc4 title="line 34 char 17 count 15,927,752">`(,</span><span class=pc4 title="line 34 char 20 count 15,927,752">x</span><span class=pc4 title="line 34 char 17 count 15,927,752"> . ,</span><span class=pc4 title="line 34 char 25 count 15,927,752">v</span><span class=pc4 title="line 34 char 17 count 15,927,752">)</span><span class=pc4 title="line 34 char 11 count 15,927,752"> </span><span class=pc4 title="line 34 char 28 count 15,927,752">s</span><span class=pc4 title="line 34 char 11 count 15,927,752">)</span><span class=pc4 title="line 32 char 3 count 15,927,752">))</span>)

(define (occurs? x v s)
  <span class=pc9 title="line 37 char 3 count 60,311,412">(let ((v </span><span class=pc9 title="line 37 char 12 count 60,311,412">(</span><span class=pc9 title="line 37 char 13 count 60,311,412">walk</span><span class=pc9 title="line 37 char 12 count 60,311,412"> </span><span class=pc9 title="line 37 char 18 count 60,311,412">v</span><span class=pc9 title="line 37 char 12 count 60,311,412"> </span><span class=pc9 title="line 37 char 20 count 60,311,412">s</span><span class=pc9 title="line 37 char 12 count 60,311,412">)</span><span class=pc9 title="line 37 char 3 count 60,311,412">))</span>
    <span class=pc9 title="line 38 char 5 count 60,311,412">(cond</span>
      <span class=pc9 title="line 38 char 5 count 60,311,412">(</span><span class=pc9 title="line 39 char 8 count 60,311,412">(</span><span class=pc9 title="line 39 char 9 count 60,311,412">var?</span><span class=pc9 title="line 39 char 8 count 60,311,412"> </span><span class=pc9 title="line 39 char 14 count 60,311,412">v</span><span class=pc9 title="line 39 char 8 count 60,311,412">)</span><span class=pc9 title="line 38 char 5 count 60,311,412"> </span><span class=pc2 title="line 39 char 17 count 4,358,604">(</span><span class=pc2 title="line 39 char 18 count 4,358,604">eqv?</span><span class=pc2 title="line 39 char 17 count 4,358,604"> </span><span class=pc2 title="line 39 char 23 count 4,358,604">v</span><span class=pc2 title="line 39 char 17 count 4,358,604"> </span><span class=pc2 title="line 39 char 25 count 4,358,604">x</span><span class=pc2 title="line 39 char 17 count 4,358,604">)</span><span class=pc9 title="line 38 char 5 count 60,311,412">)</span>
      <span class=pc9 title="line 38 char 5 count 60,311,412">(</span><span class=pc9 title="line 40 char 8 count 55,952,808">(</span><span class=pc9 title="line 40 char 9 count 55,952,808">pair?</span><span class=pc9 title="line 40 char 8 count 55,952,808"> </span><span class=pc9 title="line 40 char 15 count 55,952,808">v</span><span class=pc9 title="line 40 char 8 count 55,952,808">)</span><span class=pc9 title="line 38 char 5 count 60,311,412"> </span>
       <span class=pc5 title="line 41 char 8 count 22,191,830">(or </span><span class=pc5 title="line 41 char 12 count 22,191,830">(</span><span class=pc5 title="line 41 char 13 count 22,191,830">occurs?</span><span class=pc5 title="line 41 char 12 count 22,191,830"> </span><span class=pc5 title="line 41 char 21 count 22,191,830">x</span><span class=pc5 title="line 41 char 12 count 22,191,830"> </span><span class=pc5 title="line 41 char 23 count 22,191,830">(</span><span class=pc5 title="line 41 char 24 count 22,191,830">car</span><span class=pc5 title="line 41 char 23 count 22,191,830"> </span><span class=pc5 title="line 41 char 28 count 22,191,830">v</span><span class=pc5 title="line 41 char 23 count 22,191,830">)</span><span class=pc5 title="line 41 char 12 count 22,191,830"> </span><span class=pc5 title="line 41 char 31 count 22,191,830">s</span><span class=pc5 title="line 41 char 12 count 22,191,830">)</span>
           <span class=pc5 title="line 42 char 12 count 22,191,830">(</span><span class=pc5 title="line 42 char 13 count 22,191,830">occurs?</span><span class=pc5 title="line 42 char 12 count 22,191,830"> </span><span class=pc5 title="line 42 char 21 count 22,191,830">x</span><span class=pc5 title="line 42 char 12 count 22,191,830"> </span><span class=pc5 title="line 42 char 23 count 22,191,830">(</span><span class=pc5 title="line 42 char 24 count 22,191,830">cdr</span><span class=pc5 title="line 42 char 23 count 22,191,830"> </span><span class=pc5 title="line 42 char 28 count 22,191,830">v</span><span class=pc5 title="line 42 char 23 count 22,191,830">)</span><span class=pc5 title="line 42 char 12 count 22,191,830"> </span><span class=pc5 title="line 42 char 31 count 22,191,830">s</span><span class=pc5 title="line 42 char 12 count 22,191,830">)</span><span class=pc5 title="line 41 char 8 count 22,191,830">)</span><span class=pc9 title="line 38 char 5 count 60,311,412">)</span>
      <span class=pc9 title="line 38 char 5 count 60,311,412">(else </span><span class=pc6 title="line 43 char 13 count 33,760,978">#f</span><span class=pc9 title="line 38 char 5 count 60,311,412">))</span><span class=pc9 title="line 37 char 3 count 60,311,412">)</span>)

(define (unify u v s)
  <span class=pc8 title="line 46 char 3 count 51,325,572">(let ((u </span><span class=pc8 title="line 46 char 12 count 51,325,572">(</span><span class=pc8 title="line 46 char 13 count 51,325,572">walk</span><span class=pc8 title="line 46 char 12 count 51,325,572"> </span><span class=pc8 title="line 46 char 18 count 51,325,572">u</span><span class=pc8 title="line 46 char 12 count 51,325,572"> </span><span class=pc8 title="line 46 char 20 count 51,325,572">s</span><span class=pc8 title="line 46 char 12 count 51,325,572">)</span><span class=pc8 title="line 46 char 3 count 51,325,572">) (v </span><span class=pc8 title="line 46 char 27 count 51,325,572">(</span><span class=pc8 title="line 46 char 28 count 51,325,572">walk</span><span class=pc8 title="line 46 char 27 count 51,325,572"> </span><span class=pc8 title="line 46 char 33 count 51,325,572">v</span><span class=pc8 title="line 46 char 27 count 51,325,572"> </span><span class=pc8 title="line 46 char 35 count 51,325,572">s</span><span class=pc8 title="line 46 char 27 count 51,325,572">)</span><span class=pc8 title="line 46 char 3 count 51,325,572">))</span>
    <span class=pc8 title="line 47 char 5 count 51,325,572">(cond</span>
      <span class=pc8 title="line 47 char 5 count 51,325,572">(</span><span class=pc8 title="line 48 char 8 count 51,325,572">(</span><span class=pc8 title="line 48 char 9 count 51,325,572">eqv?</span><span class=pc8 title="line 48 char 8 count 51,325,572"> </span><span class=pc8 title="line 48 char 14 count 51,325,572">u</span><span class=pc8 title="line 48 char 8 count 51,325,572"> </span><span class=pc8 title="line 48 char 16 count 51,325,572">v</span><span class=pc8 title="line 48 char 8 count 51,325,572">)</span><span class=pc8 title="line 47 char 5 count 51,325,572"> </span><span class=pc2 title="line 48 char 19 count 3,540,235">s</span><span class=pc8 title="line 47 char 5 count 51,325,572">)</span>
      <span class=pc8 title="line 47 char 5 count 51,325,572">(</span><span class=pc8 title="line 49 char 8 count 47,785,337">(</span><span class=pc8 title="line 49 char 9 count 47,785,337">var?</span><span class=pc8 title="line 49 char 8 count 47,785,337"> </span><span class=pc8 title="line 49 char 14 count 47,785,337">u</span><span class=pc8 title="line 49 char 8 count 47,785,337">)</span><span class=pc8 title="line 47 char 5 count 51,325,572"> </span><span class=pc2 title="line 49 char 17 count 5,854,922">(</span><span class=pc2 title="line 49 char 18 count 5,854,922">ext-s</span><span class=pc2 title="line 49 char 17 count 5,854,922"> </span><span class=pc2 title="line 49 char 24 count 5,854,922">u</span><span class=pc2 title="line 49 char 17 count 5,854,922"> </span><span class=pc2 title="line 49 char 26 count 5,854,922">v</span><span class=pc2 title="line 49 char 17 count 5,854,922"> </span><span class=pc2 title="line 49 char 28 count 5,854,922">s</span><span class=pc2 title="line 49 char 17 count 5,854,922">)</span><span class=pc8 title="line 47 char 5 count 51,325,572">)</span>
      <span class=pc8 title="line 47 char 5 count 51,325,572">(</span><span class=pc7 title="line 50 char 8 count 41,930,415">(</span><span class=pc7 title="line 50 char 9 count 41,930,415">var?</span><span class=pc7 title="line 50 char 8 count 41,930,415"> </span><span class=pc7 title="line 50 char 14 count 41,930,415">v</span><span class=pc7 title="line 50 char 8 count 41,930,415">)</span><span class=pc8 title="line 47 char 5 count 51,325,572"> </span><span class=pc3 title="line 50 char 17 count 10,072,830">(</span><span class=pc3 title="line 50 char 18 count 10,072,830">ext-s</span><span class=pc3 title="line 50 char 17 count 10,072,830"> </span><span class=pc3 title="line 50 char 24 count 10,072,830">v</span><span class=pc3 title="line 50 char 17 count 10,072,830"> </span><span class=pc3 title="line 50 char 26 count 10,072,830">u</span><span class=pc3 title="line 50 char 17 count 10,072,830"> </span><span class=pc3 title="line 50 char 28 count 10,072,830">s</span><span class=pc3 title="line 50 char 17 count 10,072,830">)</span><span class=pc8 title="line 47 char 5 count 51,325,572">)</span>
      <span class=pc8 title="line 47 char 5 count 51,325,572">(</span><span class=pc6 title="line 51 char 8 count 31,857,585">(and </span><span class=pc6 title="line 51 char 13 count 31,857,585">(</span><span class=pc6 title="line 51 char 14 count 31,857,585">pair?</span><span class=pc6 title="line 51 char 13 count 31,857,585"> </span><span class=pc6 title="line 51 char 20 count 31,857,585">u</span><span class=pc6 title="line 51 char 13 count 31,857,585">)</span><span class=pc6 title="line 51 char 8 count 31,857,585"> </span><span class=pc6 title="line 51 char 23 count 28,863,445">(</span><span class=pc6 title="line 51 char 24 count 28,863,445">pair?</span><span class=pc6 title="line 51 char 23 count 28,863,445"> </span><span class=pc6 title="line 51 char 30 count 28,863,445">v</span><span class=pc6 title="line 51 char 23 count 28,863,445">)</span><span class=pc6 title="line 51 char 8 count 31,857,585">)</span>
       <span class=pc5 title="line 52 char 8 count 25,867,582">(let ((s </span><span class=pc5 title="line 52 char 17 count 25,867,582">(</span><span class=pc5 title="line 52 char 18 count 25,867,582">unify</span><span class=pc5 title="line 52 char 17 count 25,867,582"> </span><span class=pc5 title="line 52 char 24 count 25,867,582">(</span><span class=pc5 title="line 52 char 25 count 25,867,582">car</span><span class=pc5 title="line 52 char 24 count 25,867,582"> </span><span class=pc5 title="line 52 char 29 count 25,867,582">u</span><span class=pc5 title="line 52 char 24 count 25,867,582">)</span><span class=pc5 title="line 52 char 17 count 25,867,582"> </span><span class=pc5 title="line 52 char 32 count 25,867,582">(</span><span class=pc5 title="line 52 char 33 count 25,867,582">car</span><span class=pc5 title="line 52 char 32 count 25,867,582"> </span><span class=pc5 title="line 52 char 37 count 25,867,582">v</span><span class=pc5 title="line 52 char 32 count 25,867,582">)</span><span class=pc5 title="line 52 char 17 count 25,867,582"> </span><span class=pc5 title="line 52 char 40 count 25,867,582">s</span><span class=pc5 title="line 52 char 17 count 25,867,582">)</span><span class=pc5 title="line 52 char 8 count 25,867,582">))</span>
         <span class=pc5 title="line 53 char 10 count 25,867,582">(and </span><span class=pc5 title="line 53 char 15 count 25,867,582">s</span>
           <span class=pc4 title="line 54 char 12 count 16,608,929">(</span><span class=pc4 title="line 54 char 13 count 16,608,929">unify</span><span class=pc4 title="line 54 char 12 count 16,608,929"> </span><span class=pc4 title="line 54 char 19 count 16,608,929">(</span><span class=pc4 title="line 54 char 20 count 16,608,929">cdr</span><span class=pc4 title="line 54 char 19 count 16,608,929"> </span><span class=pc4 title="line 54 char 24 count 16,608,929">u</span><span class=pc4 title="line 54 char 19 count 16,608,929">)</span><span class=pc4 title="line 54 char 12 count 16,608,929"> </span><span class=pc4 title="line 54 char 27 count 16,608,929">(</span><span class=pc4 title="line 54 char 28 count 16,608,929">cdr</span><span class=pc4 title="line 54 char 27 count 16,608,929"> </span><span class=pc4 title="line 54 char 32 count 16,608,929">v</span><span class=pc4 title="line 54 char 27 count 16,608,929">)</span><span class=pc4 title="line 54 char 12 count 16,608,929"> </span><span class=pc4 title="line 54 char 35 count 16,608,929">s</span><span class=pc4 title="line 54 char 12 count 16,608,929">)</span><span class=pc5 title="line 53 char 10 count 25,867,582">)</span><span class=pc5 title="line 52 char 8 count 25,867,582">)</span><span class=pc8 title="line 47 char 5 count 51,325,572">)</span>
      <span class=pc8 title="line 47 char 5 count 51,325,572">(else </span><span class=pc2 title="line 55 char 13 count 5,990,003">#f</span><span class=pc8 title="line 47 char 5 count 51,325,572">))</span><span class=pc8 title="line 46 char 3 count 51,325,572">)</span>)

(define (== u v)
  <span class=pc3 title="line 58 char 3 count 9,123,077">(lambda (s)</span>
    <span class=pc3 title="line 59 char 5 count 8,849,061">(let ((s </span><span class=pc3 title="line 59 char 14 count 8,849,061">(</span><span class=pc3 title="line 59 char 15 count 8,849,061">unify</span><span class=pc3 title="line 59 char 14 count 8,849,061"> </span><span class=pc3 title="line 59 char 21 count 8,849,061">u</span><span class=pc3 title="line 59 char 14 count 8,849,061"> </span><span class=pc3 title="line 59 char 23 count 8,849,061">v</span><span class=pc3 title="line 59 char 14 count 8,849,061"> </span><span class=pc3 title="line 59 char 25 count 8,849,061">s</span><span class=pc3 title="line 59 char 14 count 8,849,061">)</span><span class=pc3 title="line 59 char 5 count 8,849,061">))</span>
      <span class=pc3 title="line 60 char 7 count 8,849,061">(if </span><span class=pc3 title="line 60 char 11 count 8,849,061">s</span><span class=pc3 title="line 60 char 7 count 8,849,061"> </span><span class=pc2 title="line 60 char 13 count 2,859,058">`(,</span><span class=pc2 title="line 60 char 16 count 2,859,058">s</span><span class=pc2 title="line 60 char 13 count 2,859,058">)</span><span class=pc3 title="line 60 char 7 count 8,849,061"> </span><span class=pc2 title="line 60 char 19 count 5,990,003">'()</span><span class=pc3 title="line 60 char 7 count 8,849,061">)</span><span class=pc3 title="line 59 char 5 count 8,849,061">)</span><span class=pc3 title="line 58 char 3 count 9,123,077">)</span>)

(define succeed
  (lambda (s)
    <span class=pc1 title="line 64 char 5 count 0">`(,</span><span class=pc1 title="line 64 char 8 count 0">s</span><span class=pc1 title="line 64 char 5 count 0">)</span>))
 
(define fail
  (lambda (s)
    <span class=pc2 title="line 68 char 5 count 15">'()</span>))

(define (disj2 g1 g2)
  <span class=pc3 title="line 71 char 3 count 6,127,157">(lambda (s)</span>
    <span class=pc2 title="line 72 char 5 count 5,990,149">(</span><span class=pc2 title="line 72 char 6 count 5,990,149">append-inf</span><span class=pc2 title="line 72 char 5 count 5,990,149"> </span><span class=pc2 title="line 72 char 17 count 5,990,149">(</span><span class=pc2 title="line 72 char 18 count 5,990,149">g1</span><span class=pc2 title="line 72 char 17 count 5,990,149"> </span><span class=pc2 title="line 72 char 21 count 5,990,149">s</span><span class=pc2 title="line 72 char 17 count 5,990,149">)</span><span class=pc2 title="line 72 char 5 count 5,990,149"> </span><span class=pc2 title="line 72 char 24 count 5,990,149">(</span><span class=pc2 title="line 72 char 25 count 5,990,149">g2</span><span class=pc2 title="line 72 char 24 count 5,990,149"> </span><span class=pc2 title="line 72 char 28 count 5,990,149">s</span><span class=pc2 title="line 72 char 24 count 5,990,149">)</span><span class=pc2 title="line 72 char 5 count 5,990,149">)</span><span class=pc3 title="line 71 char 3 count 6,127,157">)</span>)

(define (append-inf s-inf t-inf)
  <span class=pc4 title="line 75 char 3 count 18,534,522">(cond</span>
    <span class=pc4 title="line 75 char 3 count 18,534,522">(</span><span class=pc4 title="line 76 char 6 count 18,534,522">(</span><span class=pc4 title="line 76 char 7 count 18,534,522">null?</span><span class=pc4 title="line 76 char 6 count 18,534,522"> </span><span class=pc4 title="line 76 char 13 count 18,534,522">s-inf</span><span class=pc4 title="line 76 char 6 count 18,534,522">)</span><span class=pc4 title="line 75 char 3 count 18,534,522"> </span><span class=pc3 title="line 76 char 20 count 8,848,961">t-inf</span><span class=pc4 title="line 75 char 3 count 18,534,522">)</span>
    <span class=pc4 title="line 75 char 3 count 18,534,522">(</span><span class=pc3 title="line 77 char 6 count 9,685,561">(</span><span class=pc3 title="line 77 char 7 count 9,685,561">pair?</span><span class=pc3 title="line 77 char 6 count 9,685,561"> </span><span class=pc3 title="line 77 char 13 count 9,685,561">s-inf</span><span class=pc3 title="line 77 char 6 count 9,685,561">)</span><span class=pc4 title="line 75 char 3 count 18,534,522"> </span>
     <span class=pc2 title="line 78 char 6 count 138,171">(</span><span class=pc2 title="line 78 char 7 count 138,171">cons</span><span class=pc2 title="line 78 char 6 count 138,171"> </span><span class=pc2 title="line 78 char 12 count 138,171">(</span><span class=pc2 title="line 78 char 13 count 138,171">car</span><span class=pc2 title="line 78 char 12 count 138,171"> </span><span class=pc2 title="line 78 char 17 count 138,171">s-inf</span><span class=pc2 title="line 78 char 12 count 138,171">)</span>
       <span class=pc2 title="line 79 char 8 count 138,171">(</span><span class=pc2 title="line 79 char 9 count 138,171">append-inf</span><span class=pc2 title="line 79 char 8 count 138,171"> </span><span class=pc2 title="line 79 char 20 count 138,171">(</span><span class=pc2 title="line 79 char 21 count 138,171">cdr</span><span class=pc2 title="line 79 char 20 count 138,171"> </span><span class=pc2 title="line 79 char 25 count 138,171">s-inf</span><span class=pc2 title="line 79 char 20 count 138,171">)</span><span class=pc2 title="line 79 char 8 count 138,171"> </span><span class=pc2 title="line 79 char 32 count 138,171">t-inf</span><span class=pc2 title="line 79 char 8 count 138,171">)</span><span class=pc2 title="line 78 char 6 count 138,171">)</span><span class=pc4 title="line 75 char 3 count 18,534,522">)</span>
    <span class=pc4 title="line 75 char 3 count 18,534,522">(else </span><span class=pc3 title="line 80 char 11 count 9,547,390">(lambda () </span>
            <span class=pc3 title="line 81 char 13 count 9,547,158">(</span><span class=pc3 title="line 81 char 14 count 9,547,158">append-inf</span><span class=pc3 title="line 81 char 13 count 9,547,158"> </span><span class=pc3 title="line 81 char 25 count 9,547,158">t-inf</span><span class=pc3 title="line 81 char 13 count 9,547,158"> </span><span class=pc3 title="line 81 char 31 count 9,547,158">(</span><span class=pc3 title="line 81 char 32 count 9,547,158">s-inf</span><span class=pc3 title="line 81 char 31 count 9,547,158">)</span><span class=pc3 title="line 81 char 13 count 9,547,158">)</span><span class=pc3 title="line 80 char 11 count 9,547,390">)</span><span class=pc4 title="line 75 char 3 count 18,534,522">))</span>)

(define (take-inf n s-inf)
  <span class=pc2 title="line 84 char 3 count 1,769,658">(cond</span>
    <span class=pc2 title="line 84 char 3 count 1,769,658">(</span><span class=pc2 title="line 85 char 6 count 1,769,658">(and </span><span class=pc2 title="line 85 char 11 count 1,769,658">n</span><span class=pc2 title="line 85 char 6 count 1,769,658"> </span><span class=pc2 title="line 85 char 13 count 1,769,658">(</span><span class=pc2 title="line 85 char 14 count 1,769,658">zero?</span><span class=pc2 title="line 85 char 13 count 1,769,658"> </span><span class=pc2 title="line 85 char 20 count 1,769,658">n</span><span class=pc2 title="line 85 char 13 count 1,769,658">)</span><span class=pc2 title="line 85 char 6 count 1,769,658">)</span><span class=pc2 title="line 84 char 3 count 1,769,658"> </span><span class=pc2 title="line 85 char 24 count 1">'()</span><span class=pc2 title="line 84 char 3 count 1,769,658">)</span>
    <span class=pc2 title="line 84 char 3 count 1,769,658">(</span><span class=pc2 title="line 86 char 6 count 1,769,657">(</span><span class=pc2 title="line 86 char 7 count 1,769,657">null?</span><span class=pc2 title="line 86 char 6 count 1,769,657"> </span><span class=pc2 title="line 86 char 13 count 1,769,657">s-inf</span><span class=pc2 title="line 86 char 6 count 1,769,657">)</span><span class=pc2 title="line 84 char 3 count 1,769,658"> </span><span class=pc1 title="line 86 char 20 count 0">'()</span><span class=pc2 title="line 84 char 3 count 1,769,658">)</span>
    <span class=pc2 title="line 84 char 3 count 1,769,658">(</span><span class=pc2 title="line 87 char 6 count 1,769,657">(</span><span class=pc2 title="line 87 char 7 count 1,769,657">pair?</span><span class=pc2 title="line 87 char 6 count 1,769,657"> </span><span class=pc2 title="line 87 char 13 count 1,769,657">s-inf</span><span class=pc2 title="line 87 char 6 count 1,769,657">)</span><span class=pc2 title="line 84 char 3 count 1,769,658"> </span>
     <span class=pc2 title="line 88 char 6 count 4">(</span><span class=pc2 title="line 88 char 7 count 4">cons</span><span class=pc2 title="line 88 char 6 count 4"> </span><span class=pc2 title="line 88 char 12 count 4">(</span><span class=pc2 title="line 88 char 13 count 4">car</span><span class=pc2 title="line 88 char 12 count 4"> </span><span class=pc2 title="line 88 char 17 count 4">s-inf</span><span class=pc2 title="line 88 char 12 count 4">)</span>
       <span class=pc2 title="line 89 char 8 count 4">(</span><span class=pc2 title="line 89 char 9 count 4">take-inf</span><span class=pc2 title="line 89 char 8 count 4"> </span><span class=pc2 title="line 89 char 18 count 4">(and </span><span class=pc2 title="line 89 char 23 count 4">n</span><span class=pc2 title="line 89 char 18 count 4"> </span><span class=pc2 title="line 89 char 25 count 4">(</span><span class=pc2 title="line 89 char 26 count 4">sub1</span><span class=pc2 title="line 89 char 25 count 4"> </span><span class=pc2 title="line 89 char 31 count 4">n</span><span class=pc2 title="line 89 char 25 count 4">)</span><span class=pc2 title="line 89 char 18 count 4">)</span>
         <span class=pc2 title="line 90 char 10 count 4">(</span><span class=pc2 title="line 90 char 11 count 4">cdr</span><span class=pc2 title="line 90 char 10 count 4"> </span><span class=pc2 title="line 90 char 15 count 4">s-inf</span><span class=pc2 title="line 90 char 10 count 4">)</span><span class=pc2 title="line 89 char 8 count 4">)</span><span class=pc2 title="line 88 char 6 count 4">)</span><span class=pc2 title="line 84 char 3 count 1,769,658">)</span>
    <span class=pc2 title="line 84 char 3 count 1,769,658">(else </span><span class=pc2 title="line 91 char 11 count 1,769,653">(</span><span class=pc2 title="line 91 char 12 count 1,769,653">take-inf</span><span class=pc2 title="line 91 char 11 count 1,769,653"> </span><span class=pc2 title="line 91 char 21 count 1,769,653">n</span><span class=pc2 title="line 91 char 11 count 1,769,653"> </span><span class=pc2 title="line 91 char 23 count 1,769,653">(</span><span class=pc2 title="line 91 char 24 count 1,769,653">s-inf</span><span class=pc2 title="line 91 char 23 count 1,769,653">)</span><span class=pc2 title="line 91 char 11 count 1,769,653">)</span><span class=pc2 title="line 84 char 3 count 1,769,658">))</span>)

(define (conj2 g1 g2)
  <span class=pc2 title="line 94 char 3 count 2,995,925">(lambda (s)</span>
    <span class=pc2 title="line 95 char 5 count 2,994,320">(</span><span class=pc2 title="line 95 char 6 count 2,994,320">append-map-inf</span><span class=pc2 title="line 95 char 5 count 2,994,320"> </span><span class=pc2 title="line 95 char 21 count 2,994,320">g2</span><span class=pc2 title="line 95 char 5 count 2,994,320"> </span><span class=pc2 title="line 95 char 24 count 2,994,320">(</span><span class=pc2 title="line 95 char 25 count 2,994,320">g1</span><span class=pc2 title="line 95 char 24 count 2,994,320"> </span><span class=pc2 title="line 95 char 28 count 2,994,320">s</span><span class=pc2 title="line 95 char 24 count 2,994,320">)</span><span class=pc2 title="line 95 char 5 count 2,994,320">)</span><span class=pc2 title="line 94 char 3 count 2,995,925">)</span>)

(define (append-map-inf g s-inf)
  <span class=pc3 title="line 98 char 3 count 7,613,777">(cond</span>
    <span class=pc3 title="line 98 char 3 count 7,613,777">(</span><span class=pc3 title="line 99 char 6 count 7,613,777">(</span><span class=pc3 title="line 99 char 7 count 7,613,777">null?</span><span class=pc3 title="line 99 char 6 count 7,613,777"> </span><span class=pc3 title="line 99 char 13 count 7,613,777">s-inf</span><span class=pc3 title="line 99 char 6 count 7,613,777">)</span><span class=pc3 title="line 98 char 3 count 7,613,777"> </span><span class=pc2 title="line 99 char 20 count 2,994,229">'()</span><span class=pc3 title="line 98 char 3 count 7,613,777">)</span>
    <span class=pc3 title="line 98 char 3 count 7,613,777">(</span><span class=pc2 title="line 100 char 6 count 4,619,548">(</span><span class=pc2 title="line 100 char 7 count 4,619,548">pair?</span><span class=pc2 title="line 100 char 6 count 4,619,548"> </span><span class=pc2 title="line 100 char 13 count 4,619,548">s-inf</span><span class=pc2 title="line 100 char 6 count 4,619,548">)</span>
     <span class=pc2 title="line 101 char 6 count 2,859,044">(</span><span class=pc2 title="line 101 char 7 count 2,859,044">append-inf</span><span class=pc2 title="line 101 char 6 count 2,859,044"> </span><span class=pc2 title="line 101 char 18 count 2,859,044">(</span><span class=pc2 title="line 101 char 19 count 2,859,044">g</span><span class=pc2 title="line 101 char 18 count 2,859,044"> </span><span class=pc2 title="line 101 char 21 count 2,859,044">(</span><span class=pc2 title="line 101 char 22 count 2,859,044">car</span><span class=pc2 title="line 101 char 21 count 2,859,044"> </span><span class=pc2 title="line 101 char 26 count 2,859,044">s-inf</span><span class=pc2 title="line 101 char 21 count 2,859,044">)</span><span class=pc2 title="line 101 char 18 count 2,859,044">)</span>
       <span class=pc2 title="line 102 char 8 count 2,859,044">(</span><span class=pc2 title="line 102 char 9 count 2,859,044">append-map-inf</span><span class=pc2 title="line 102 char 8 count 2,859,044"> </span><span class=pc2 title="line 102 char 24 count 2,859,044">g</span><span class=pc2 title="line 102 char 8 count 2,859,044"> </span><span class=pc2 title="line 102 char 26 count 2,859,044">(</span><span class=pc2 title="line 102 char 27 count 2,859,044">cdr</span><span class=pc2 title="line 102 char 26 count 2,859,044"> </span><span class=pc2 title="line 102 char 31 count 2,859,044">s-inf</span><span class=pc2 title="line 102 char 26 count 2,859,044">)</span><span class=pc2 title="line 102 char 8 count 2,859,044">)</span><span class=pc2 title="line 101 char 6 count 2,859,044">)</span><span class=pc3 title="line 98 char 3 count 7,613,777">)</span>
    <span class=pc3 title="line 98 char 3 count 7,613,777">(else </span><span class=pc2 title="line 103 char 11 count 1,760,504">(lambda () </span>
            <span class=pc2 title="line 104 char 13 count 1,760,413">(</span><span class=pc2 title="line 104 char 14 count 1,760,413">append-map-inf</span><span class=pc2 title="line 104 char 13 count 1,760,413"> </span><span class=pc2 title="line 104 char 29 count 1,760,413">g</span><span class=pc2 title="line 104 char 13 count 1,760,413"> </span><span class=pc2 title="line 104 char 31 count 1,760,413">(</span><span class=pc2 title="line 104 char 32 count 1,760,413">s-inf</span><span class=pc2 title="line 104 char 31 count 1,760,413">)</span><span class=pc2 title="line 104 char 13 count 1,760,413">)</span><span class=pc2 title="line 103 char 11 count 1,760,504">)</span><span class=pc3 title="line 98 char 3 count 7,613,777">))</span>)

(define (call/fresh name f)
  <span class=pc3 title="line 107 char 3 count 11,983,520">(</span><span class=pc3 title="line 107 char 4 count 11,983,520">f</span><span class=pc3 title="line 107 char 3 count 11,983,520"> </span><span class=pc3 title="line 107 char 6 count 11,983,520">(</span><span class=pc3 title="line 107 char 7 count 11,983,520">var</span><span class=pc3 title="line 107 char 6 count 11,983,520"> </span><span class=pc3 title="line 107 char 11 count 11,983,520">name</span><span class=pc3 title="line 107 char 6 count 11,983,520">)</span><span class=pc3 title="line 107 char 3 count 11,983,520">)</span>)

(define (reify-name n)
  <span class=pc1 title="line 110 char 3 count 0">(</span><span class=pc1 title="line 110 char 4 count 0">string-&gt;symbol</span>
    <span class=pc1 title="line 111 char 5 count 0">(</span><span class=pc1 title="line 111 char 6 count 0">string-append</span><span class=pc1 title="line 111 char 5 count 0"> </span><span class=pc1 title="line 111 char 20 count 0">"_"</span>
      <span class=pc1 title="line 112 char 7 count 0">(</span><span class=pc1 title="line 112 char 8 count 0">number-&gt;string</span><span class=pc1 title="line 112 char 7 count 0"> </span><span class=pc1 title="line 112 char 23 count 0">n</span><span class=pc1 title="line 112 char 7 count 0">)</span><span class=pc1 title="line 111 char 5 count 0">)</span><span class=pc1 title="line 110 char 3 count 0">)</span>)

(define (walk* v s)
  <span class=pc2 title="line 115 char 3 count 72">(let ((v </span><span class=pc2 title="line 115 char 12 count 72">(</span><span class=pc2 title="line 115 char 13 count 72">walk</span><span class=pc2 title="line 115 char 12 count 72"> </span><span class=pc2 title="line 115 char 18 count 72">v</span><span class=pc2 title="line 115 char 12 count 72"> </span><span class=pc2 title="line 115 char 20 count 72">s</span><span class=pc2 title="line 115 char 12 count 72">)</span><span class=pc2 title="line 115 char 3 count 72">))</span>
    <span class=pc2 title="line 116 char 5 count 72">(cond</span>
      <span class=pc2 title="line 116 char 5 count 72">(</span><span class=pc2 title="line 117 char 8 count 72">(</span><span class=pc2 title="line 117 char 9 count 72">var?</span><span class=pc2 title="line 117 char 8 count 72"> </span><span class=pc2 title="line 117 char 14 count 72">v</span><span class=pc2 title="line 117 char 8 count 72">)</span><span class=pc2 title="line 116 char 5 count 72"> </span><span class=pc1 title="line 117 char 17 count 0">v</span><span class=pc2 title="line 116 char 5 count 72">)</span>
      <span class=pc2 title="line 116 char 5 count 72">(</span><span class=pc2 title="line 118 char 8 count 72">(</span><span class=pc2 title="line 118 char 9 count 72">pair?</span><span class=pc2 title="line 118 char 8 count 72"> </span><span class=pc2 title="line 118 char 15 count 72">v</span><span class=pc2 title="line 118 char 8 count 72">)</span>
       <span class=pc2 title="line 119 char 8 count 32">(</span><span class=pc2 title="line 119 char 9 count 32">cons</span>
         <span class=pc2 title="line 120 char 10 count 32">(</span><span class=pc2 title="line 120 char 11 count 32">walk*</span><span class=pc2 title="line 120 char 10 count 32"> </span><span class=pc2 title="line 120 char 17 count 32">(</span><span class=pc2 title="line 120 char 18 count 32">car</span><span class=pc2 title="line 120 char 17 count 32"> </span><span class=pc2 title="line 120 char 22 count 32">v</span><span class=pc2 title="line 120 char 17 count 32">)</span><span class=pc2 title="line 120 char 10 count 32"> </span><span class=pc2 title="line 120 char 25 count 32">s</span><span class=pc2 title="line 120 char 10 count 32">)</span>
         <span class=pc2 title="line 121 char 10 count 32">(</span><span class=pc2 title="line 121 char 11 count 32">walk*</span><span class=pc2 title="line 121 char 10 count 32"> </span><span class=pc2 title="line 121 char 17 count 32">(</span><span class=pc2 title="line 121 char 18 count 32">cdr</span><span class=pc2 title="line 121 char 17 count 32"> </span><span class=pc2 title="line 121 char 22 count 32">v</span><span class=pc2 title="line 121 char 17 count 32">)</span><span class=pc2 title="line 121 char 10 count 32"> </span><span class=pc2 title="line 121 char 25 count 32">s</span><span class=pc2 title="line 121 char 10 count 32">)</span><span class=pc2 title="line 119 char 8 count 32">)</span><span class=pc2 title="line 116 char 5 count 72">)</span>
      <span class=pc2 title="line 116 char 5 count 72">(else </span><span class=pc2 title="line 122 char 13 count 40">v</span><span class=pc2 title="line 116 char 5 count 72">))</span><span class=pc2 title="line 115 char 3 count 72">)</span>)

; 'project' is defined in the frame 10:98 on page 166.
(define-syntax project
  (syntax-rules ()
    ((project (x ...) g ...)
     (lambda (s)
       (let ((x (walk* x s)) ...)
         ((conj g ...) s))))))

(define (reify-s v r)
  <span class=pc2 title="line 133 char 3 count 36">(let ((v </span><span class=pc2 title="line 133 char 12 count 36">(</span><span class=pc2 title="line 133 char 13 count 36">walk</span><span class=pc2 title="line 133 char 12 count 36"> </span><span class=pc2 title="line 133 char 18 count 36">v</span><span class=pc2 title="line 133 char 12 count 36"> </span><span class=pc2 title="line 133 char 20 count 36">r</span><span class=pc2 title="line 133 char 12 count 36">)</span><span class=pc2 title="line 133 char 3 count 36">))</span>
    <span class=pc2 title="line 134 char 5 count 36">(cond</span>
      <span class=pc2 title="line 134 char 5 count 36">(</span><span class=pc2 title="line 135 char 8 count 36">(</span><span class=pc2 title="line 135 char 9 count 36">var?</span><span class=pc2 title="line 135 char 8 count 36"> </span><span class=pc2 title="line 135 char 14 count 36">v</span><span class=pc2 title="line 135 char 8 count 36">)</span>
       <span class=pc1 title="line 136 char 8 count 0">(let ((n </span><span class=pc1 title="line 136 char 17 count 0">(</span><span class=pc1 title="line 136 char 18 count 0">length</span><span class=pc1 title="line 136 char 17 count 0"> </span><span class=pc1 title="line 136 char 25 count 0">r</span><span class=pc1 title="line 136 char 17 count 0">)</span><span class=pc1 title="line 136 char 8 count 0">))</span>
         <span class=pc1 title="line 137 char 10 count 0">(let ((rn </span><span class=pc1 title="line 137 char 20 count 0">(</span><span class=pc1 title="line 137 char 21 count 0">reify-name</span><span class=pc1 title="line 137 char 20 count 0"> </span><span class=pc1 title="line 137 char 32 count 0">n</span><span class=pc1 title="line 137 char 20 count 0">)</span><span class=pc1 title="line 137 char 10 count 0">))</span>
           <span class=pc1 title="line 138 char 12 count 0">(</span><span class=pc1 title="line 138 char 13 count 0">cons</span><span class=pc1 title="line 138 char 12 count 0"> </span><span class=pc1 title="line 138 char 18 count 0">`(,</span><span class=pc1 title="line 138 char 21 count 0">v</span><span class=pc1 title="line 138 char 18 count 0"> . ,</span><span class=pc1 title="line 138 char 26 count 0">rn</span><span class=pc1 title="line 138 char 18 count 0">)</span><span class=pc1 title="line 138 char 12 count 0"> </span><span class=pc1 title="line 138 char 30 count 0">r</span><span class=pc1 title="line 138 char 12 count 0">)</span><span class=pc1 title="line 137 char 10 count 0">)</span><span class=pc1 title="line 136 char 8 count 0">)</span><span class=pc2 title="line 134 char 5 count 36">)</span>
      <span class=pc2 title="line 134 char 5 count 36">(</span><span class=pc2 title="line 139 char 8 count 36">(</span><span class=pc2 title="line 139 char 9 count 36">pair?</span><span class=pc2 title="line 139 char 8 count 36"> </span><span class=pc2 title="line 139 char 15 count 36">v</span><span class=pc2 title="line 139 char 8 count 36">)</span>
       <span class=pc2 title="line 140 char 8 count 16">(let ((r </span><span class=pc2 title="line 140 char 17 count 16">(</span><span class=pc2 title="line 140 char 18 count 16">reify-s</span><span class=pc2 title="line 140 char 17 count 16"> </span><span class=pc2 title="line 140 char 26 count 16">(</span><span class=pc2 title="line 140 char 27 count 16">car</span><span class=pc2 title="line 140 char 26 count 16"> </span><span class=pc2 title="line 140 char 31 count 16">v</span><span class=pc2 title="line 140 char 26 count 16">)</span><span class=pc2 title="line 140 char 17 count 16"> </span><span class=pc2 title="line 140 char 34 count 16">r</span><span class=pc2 title="line 140 char 17 count 16">)</span><span class=pc2 title="line 140 char 8 count 16">))</span>
         <span class=pc2 title="line 141 char 10 count 16">(</span><span class=pc2 title="line 141 char 11 count 16">reify-s</span><span class=pc2 title="line 141 char 10 count 16"> </span><span class=pc2 title="line 141 char 19 count 16">(</span><span class=pc2 title="line 141 char 20 count 16">cdr</span><span class=pc2 title="line 141 char 19 count 16"> </span><span class=pc2 title="line 141 char 24 count 16">v</span><span class=pc2 title="line 141 char 19 count 16">)</span><span class=pc2 title="line 141 char 10 count 16"> </span><span class=pc2 title="line 141 char 27 count 16">r</span><span class=pc2 title="line 141 char 10 count 16">)</span><span class=pc2 title="line 140 char 8 count 16">)</span><span class=pc2 title="line 134 char 5 count 36">)</span>
      <span class=pc2 title="line 134 char 5 count 36">(else </span><span class=pc2 title="line 142 char 13 count 20">r</span><span class=pc2 title="line 134 char 5 count 36">))</span><span class=pc2 title="line 133 char 3 count 36">)</span>)

(define (reify v)
  <span class=pc2 title="line 145 char 3 count 1">(lambda (s)</span>
    <span class=pc2 title="line 146 char 5 count 4">(let ((v </span><span class=pc2 title="line 146 char 14 count 4">(</span><span class=pc2 title="line 146 char 15 count 4">walk*</span><span class=pc2 title="line 146 char 14 count 4"> </span><span class=pc2 title="line 146 char 21 count 4">v</span><span class=pc2 title="line 146 char 14 count 4"> </span><span class=pc2 title="line 146 char 23 count 4">s</span><span class=pc2 title="line 146 char 14 count 4">)</span><span class=pc2 title="line 146 char 5 count 4">))</span>
      <span class=pc2 title="line 147 char 7 count 4">(let ((r </span><span class=pc2 title="line 147 char 16 count 4">(</span><span class=pc2 title="line 147 char 17 count 4">reify-s</span><span class=pc2 title="line 147 char 16 count 4"> </span><span class=pc2 title="line 147 char 25 count 4">v</span><span class=pc2 title="line 147 char 16 count 4"> </span><span class=pc2 title="line 147 char 27 count 4">empty-s</span><span class=pc2 title="line 147 char 16 count 4">)</span><span class=pc2 title="line 147 char 7 count 4">))</span>
        <span class=pc2 title="line 148 char 9 count 4">(</span><span class=pc2 title="line 148 char 10 count 4">walk*</span><span class=pc2 title="line 148 char 9 count 4"> </span><span class=pc2 title="line 148 char 16 count 4">v</span><span class=pc2 title="line 148 char 9 count 4"> </span><span class=pc2 title="line 148 char 18 count 4">r</span><span class=pc2 title="line 148 char 9 count 4">)</span><span class=pc2 title="line 147 char 7 count 4">)</span><span class=pc2 title="line 146 char 5 count 4">)</span><span class=pc2 title="line 145 char 3 count 1">)</span>)

(define (run-goal n g)
  <span class=pc2 title="line 151 char 3 count 1">(</span><span class=pc2 title="line 151 char 4 count 1">take-inf</span><span class=pc2 title="line 151 char 3 count 1"> </span><span class=pc2 title="line 151 char 13 count 1">n</span><span class=pc2 title="line 151 char 3 count 1"> </span><span class=pc2 title="line 151 char 15 count 1">(</span><span class=pc2 title="line 151 char 16 count 1">g</span><span class=pc2 title="line 151 char 15 count 1"> </span><span class=pc2 title="line 151 char 18 count 1">empty-s</span><span class=pc2 title="line 151 char 15 count 1">)</span><span class=pc2 title="line 151 char 3 count 1">)</span>)

(define (ifte g1 g2 g3)
  <span class=pc1 title="line 154 char 3 count 0">(lambda (s)</span>
    <span class=pc1 title="line 155 char 5 count 0">(let loop ((s-inf </span><span class=pc1 title="line 155 char 23 count 0">(</span><span class=pc1 title="line 155 char 24 count 0">g1</span><span class=pc1 title="line 155 char 23 count 0"> </span><span class=pc1 title="line 155 char 27 count 0">s</span><span class=pc1 title="line 155 char 23 count 0">)</span><span class=pc1 title="line 155 char 5 count 0">))</span>
      <span class=pc1 title="line 156 char 7 count 0">(cond</span>
        <span class=pc1 title="line 156 char 7 count 0">(</span><span class=pc1 title="line 157 char 10 count 0">(</span><span class=pc1 title="line 157 char 11 count 0">null?</span><span class=pc1 title="line 157 char 10 count 0"> </span><span class=pc1 title="line 157 char 17 count 0">s-inf</span><span class=pc1 title="line 157 char 10 count 0">)</span><span class=pc1 title="line 156 char 7 count 0"> </span><span class=pc1 title="line 157 char 24 count 0">(</span><span class=pc1 title="line 157 char 25 count 0">g3</span><span class=pc1 title="line 157 char 24 count 0"> </span><span class=pc1 title="line 157 char 28 count 0">s</span><span class=pc1 title="line 157 char 24 count 0">)</span><span class=pc1 title="line 156 char 7 count 0">)</span>
        <span class=pc1 title="line 156 char 7 count 0">(</span><span class=pc1 title="line 158 char 10 count 0">(</span><span class=pc1 title="line 158 char 11 count 0">pair?</span><span class=pc1 title="line 158 char 10 count 0"> </span><span class=pc1 title="line 158 char 17 count 0">s-inf</span><span class=pc1 title="line 158 char 10 count 0">)</span>
         <span class=pc1 title="line 159 char 10 count 0">(</span><span class=pc1 title="line 159 char 11 count 0">append-map-inf</span><span class=pc1 title="line 159 char 10 count 0"> </span><span class=pc1 title="line 159 char 26 count 0">g2</span><span class=pc1 title="line 159 char 10 count 0"> </span><span class=pc1 title="line 159 char 29 count 0">s-inf</span><span class=pc1 title="line 159 char 10 count 0">)</span><span class=pc1 title="line 156 char 7 count 0">)</span>
        <span class=pc1 title="line 156 char 7 count 0">(else </span><span class=pc1 title="line 160 char 15 count 0">(lambda ()</span>
                <span class=pc1 title="line 161 char 17 count 0">(</span><span class=pc1 title="line 161 char 18 count 0">loop</span><span class=pc1 title="line 161 char 17 count 0"> </span><span class=pc1 title="line 161 char 23 count 0">(</span><span class=pc1 title="line 161 char 24 count 0">s-inf</span><span class=pc1 title="line 161 char 23 count 0">)</span><span class=pc1 title="line 161 char 17 count 0">)</span><span class=pc1 title="line 160 char 15 count 0">)</span><span class=pc1 title="line 156 char 7 count 0">))</span><span class=pc1 title="line 155 char 5 count 0">)</span><span class=pc1 title="line 154 char 3 count 0">)</span>)

(define (once g)
  <span class=pc1 title="line 164 char 3 count 0">(lambda (s)</span>
    <span class=pc1 title="line 165 char 5 count 0">(let loop ((s-inf </span><span class=pc1 title="line 165 char 23 count 0">(</span><span class=pc1 title="line 165 char 24 count 0">g</span><span class=pc1 title="line 165 char 23 count 0"> </span><span class=pc1 title="line 165 char 26 count 0">s</span><span class=pc1 title="line 165 char 23 count 0">)</span><span class=pc1 title="line 165 char 5 count 0">))</span>
      <span class=pc1 title="line 166 char 7 count 0">(cond</span>
        <span class=pc1 title="line 166 char 7 count 0">(</span><span class=pc1 title="line 167 char 10 count 0">(</span><span class=pc1 title="line 167 char 11 count 0">null?</span><span class=pc1 title="line 167 char 10 count 0"> </span><span class=pc1 title="line 167 char 17 count 0">s-inf</span><span class=pc1 title="line 167 char 10 count 0">)</span><span class=pc1 title="line 166 char 7 count 0"> </span><span class=pc1 title="line 167 char 24 count 0">'()</span><span class=pc1 title="line 166 char 7 count 0">)</span>
        <span class=pc1 title="line 166 char 7 count 0">(</span><span class=pc1 title="line 168 char 10 count 0">(</span><span class=pc1 title="line 168 char 11 count 0">pair?</span><span class=pc1 title="line 168 char 10 count 0"> </span><span class=pc1 title="line 168 char 17 count 0">s-inf</span><span class=pc1 title="line 168 char 10 count 0">)</span>
         <span class=pc1 title="line 169 char 10 count 0">(</span><span class=pc1 title="line 169 char 11 count 0">cons</span><span class=pc1 title="line 169 char 10 count 0"> </span><span class=pc1 title="line 169 char 16 count 0">(</span><span class=pc1 title="line 169 char 17 count 0">car</span><span class=pc1 title="line 169 char 16 count 0"> </span><span class=pc1 title="line 169 char 21 count 0">s-inf</span><span class=pc1 title="line 169 char 16 count 0">)</span><span class=pc1 title="line 169 char 10 count 0"> </span><span class=pc1 title="line 169 char 28 count 0">'()</span><span class=pc1 title="line 169 char 10 count 0">)</span><span class=pc1 title="line 166 char 7 count 0">)</span>
        <span class=pc1 title="line 166 char 7 count 0">(else </span><span class=pc1 title="line 170 char 15 count 0">(lambda ()</span>
                <span class=pc1 title="line 171 char 17 count 0">(</span><span class=pc1 title="line 171 char 18 count 0">loop</span><span class=pc1 title="line 171 char 17 count 0"> </span><span class=pc1 title="line 171 char 23 count 0">(</span><span class=pc1 title="line 171 char 24 count 0">s-inf</span><span class=pc1 title="line 171 char 23 count 0">)</span><span class=pc1 title="line 171 char 17 count 0">)</span><span class=pc1 title="line 170 char 15 count 0">)</span><span class=pc1 title="line 166 char 7 count 0">))</span><span class=pc1 title="line 165 char 5 count 0">)</span><span class=pc1 title="line 164 char 3 count 0">)</span>)


;;; Here are the key parts of Appendix A

(define-syntax disj
  (syntax-rules ()
    ((disj) fail)
    ((disj g) g)
    ((disj g0 g ...) (<span class=pc3 title="line 180 char 23 count 6,127,157">disj2</span> g0 (disj g ...)))))

(define-syntax conj
  (syntax-rules ()
    ((conj) succeed)
    ((conj g) g)
    ((conj g0 g ...) (<span class=pc2 title="line 186 char 23 count 2,995,924">conj2</span> g0 (conj g ...)))))

(define-syntax defrel
  (syntax-rules ()
    ((defrel (name x ...) g ...)
     (define (name x ...)
       (lambda (s)
         (lambda ()
           ((conj g ...) <span class=pc2 title="line 194 char 26 count 1,769,607">s</span>)))))))

(define-syntax run
  (syntax-rules ()
    ((run n (x0 x ...) g ...)
     (run n q (fresh (x0 x ...)
                (== `(,x0 ,x ...) q) g ...)))
    ((run n q g ...)
     (let ((q (var 'q)))
       (map (reify q)
         (run-goal n (conj g ...)))))))

(define-syntax run*
  (syntax-rules ()
    ((run* q g ...) (run #f q g ...))))

(define-syntax fresh
  (syntax-rules ()
    ((fresh () g ...) (conj g ...))
    ((fresh (x0 x ...) g ...)
     (<span class=pc3 title="line 214 char 7 count 11,983,519">call/fresh</span> <span class=pc3 title="line 214 char 18 count 11,983,519">'x_0</span>
       (lambda (x0)
         (fresh (x ...) g ...))))))

(define-syntax conde
  (syntax-rules ()
    ((conde (g ...) ...)
     (disj (conj g ...) ...))))

(define-syntax conda
  (syntax-rules ()
    ((conda (g0 g ...)) (conj g0 g ...))
    ((conda (g0 g ...) ln ...)
     (ifte g0 (conj g ...) (conda ln ...)))))

(define-syntax condu
  (syntax-rules ()
    ((condu (g0 g ...) ...)
     (conda ((once g0) g ...) ...))))
</pre></td></tr></table>
</body>
</html>